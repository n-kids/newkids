<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‰´í‚¤ì¦ˆ - ì œì•ˆ/ê²¬ì  ìš”ì²­</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header></header>

    <section class="sub-hero bg-proposal">
        <div class="container">
            <h1>ì œì•ˆì„œ ë° ê²¬ì  ìš”ì²­</h1>
            <p>ê´€ì‹¬ ìˆëŠ” ì¹´í…Œê³ ë¦¬ë¥¼ ì²´í¬í•˜ê³  ì„¸ë¶€ í”„ë¡œê·¸ë¨ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
        </div>
    </section>

    <section style="background-color: #f8f9fa;">
        <div class="container">

            <form id="proposalForm" class="proposal-box">
                <h3 class="form-section-title">ğŸ‘¤ ì‹ ì²­ì ì •ë³´</h3>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">ì›ëª… (í•„ìˆ˜)</label>
                        <input type="text" name="wonName" class="form-input" placeholder="ì˜ˆ: í•´ë°”ë¼ê¸° ì–´ë¦°ì´ì§‘" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ë‹´ë‹¹ì ì„±í•¨ (í•„ìˆ˜)</label>
                        <input type="text" name="manager" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì—°ë½ì²˜ (í•„ìˆ˜)</label>
                        <input type="tel" name="phone" class="form-input" placeholder="010-0000-0000" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì´ë©”ì¼</label>
                        <input type="email" name="email" class="form-input" placeholder="sample@email.com">
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">ì§€ì—­ (í•„ìˆ˜)</label>
                        <input type="text" name="region" class="form-input" placeholder="ì˜ˆ: ê²½ê¸°ë„ ê¹€í¬ì‹œ (ì‹œ/êµ°/êµ¬ ê¹Œì§€ë§Œ ì…ë ¥)" required>
                    </div>
                </div>

                <h3 class="form-section-title" style="margin-top: 40px;">ğŸ“š ê´€ì‹¬ í”„ë¡œê·¸ë¨ ì„ íƒ</h3>
                <p style="font-size:0.9rem; color:#666; margin-bottom:15px;">
                    <strong>[ì‚¬ìš©ë²•]</strong> ì›í•˜ì‹œëŠ” <u>ì¹´í…Œê³ ë¦¬(ì¤‘ë¶„ë¥˜)ë¥¼ í´ë¦­</u>í•˜ì—¬ ìƒì„¸ í”„ë¡œê·¸ë¨ì„ ì„ íƒí•˜ì„¸ìš”.
                </p>

                <div id="loading-msg" style="text-align:center; padding:20px; color:#666;">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>

                <div id="proposal-list-area" class="proposal-list-box"></div>

                <div class="form-group full-width" style="margin-top: 30px;">
                    <label class="form-label">ë°©ë¬¸ í¬ë§ ë‚ ì§œ (ì„ íƒ)</label>
                    <input type="date" name="visitDate" class="form-input" style="max-width: 300px;">
                    <p style="font-size:0.8rem; color:#888; margin-top:5px;">â€» ì›í•˜ì‹œëŠ” í–‰ì‚¬/ìƒë‹´ ë‚ ì§œê°€ ìˆë‹¤ë©´ ì§€ì •í•´ ì£¼ì„¸ìš”.</p>
                </div>

                <div class="form-group full-width" style="margin-top: 20px;">
                    <label class="form-label">ë¬¸ì˜ì‚¬í•­ ë° ìš”ì²­ ë‚´ìš©</label>
                    <textarea name="inquiry" class="form-input" placeholder="ê¶ê¸ˆí•˜ì‹  ì ì´ë‚˜ íŠ¹ë³„íˆ ìš”ì²­í•˜ì‹¤ ë‚´ìš©ì„ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”."></textarea>
                </div>

                <div class="btn-center-wrap">
                    <button onclick="submitOrder()" class="btn-action">ê²¬ì  ë° ìƒë‹´ ìš”ì²­í•˜ê¸°</button>
                </div>
            </form>

        </div>
    </section>

    <footer></footer>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="manager.js"></script>

    <script>
        const EDU_CATS = ['korean', 'art', 'science', 'coding', 'english', 'integrated'];
        const EVENT_CATS = ['season', 'culture', 'performance'];

        const CAT_NAMES = {
            'korean': 'ğŸ“š í•œê¸€ & ë…ì„œ',
            'art': 'ğŸ¨ ë¯¸ìˆ  & ìì—°',
            'science': 'ğŸ”¬ ìˆ˜í•™ & ê³¼í•™',
            'coding': 'ğŸ’» ì½”ë”© & ì§ì—…',
            'english': 'ğŸ”¤ ì˜ì–´ & ì§€ë„',
            'integrated': 'ğŸ‘¶ í†µí•©ë³´ìœ¡ & ëˆ„ë¦¬',
            'season': 'ğŸ‰ ì‹œì¦Œ í…Œë§ˆ í–‰ì‚¬',
            'culture': 'ğŸŒ ì›ì–´ë¯¼ í–‰ì‚¬',
            'performance': 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ë¶€ëª¨ ì°¸ì—¬ í–‰ì‚¬'
        };

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        document.addEventListener("DOMContentLoaded", function () {
            let attempts = 0;
            const checkSb = setInterval(() => {
                attempts++;
                if (window.sb) {
                    clearInterval(checkSb);
                    loadProposalItems(window.sb);
                } else if (attempts > 50) {
                    clearInterval(checkSb);
                    document.getElementById('loading-msg').innerText = "ë°ì´í„° ë¡œë”© ì‹¤íŒ¨";
                }
            }, 100);
        });

        async function loadProposalItems(sb) {
            try {
                const allCats = [...EDU_CATS, ...EVENT_CATS];
                const { data, error } = await sb
                    .from('total_posts')
                    .select('id, title, category')
                    .in('category', allCats)
                    .order('category', { ascending: true })
                    .order('created_at', { ascending: false });

                const listArea = document.getElementById('proposal-list-area');
                document.getElementById('loading-msg').style.display = 'none';

                if (error) { console.error(error); return; }

                const grouped = data.reduce((acc, item) => {
                    const c = item.category;
                    (acc[c] = acc[c] || []).push(item);
                    return acc;
                }, {});

                let html = "";

                const createGroupHTML = (title, categories) => {
                    let groupHtml = `<div class="category-wrapper">`;

                    groupHtml += `<div class="proposal-category-header" onclick="toggleProposalCategory(this)">
                                        <span>${title}</span> <span class="toggle-icon">â–¼</span>
                                    </div>`;

                    groupHtml += `<div class="proposal-category-content">`;

                    let hasItem = false;
                    categories.forEach(cat => {
                        if (grouped[cat] && grouped[cat].length > 0) {
                            hasItem = true;
                            // [ìˆ˜ì •] ì¤‘ë¶„ë¥˜ í—¤ë” êµ¬ì¡° ë³€ê²½ (sub-cat-title ë˜í¼ ì¶”ê°€)
                            groupHtml += `
                                                <div class="sub-cat-header" onclick="toggleSubCategory(this)">
                                                    <div class="sub-cat-title">
                                                        <input type="checkbox" class="parent-check" data-cat="${cat}">
                                                        <span>${CAT_NAMES[cat] || cat}</span>
                                                    </div>
                                                    <span class="sub-toggle-icon">â–¼</span>
                                                </div>
                                            `;
                            groupHtml += `<div id="grid-${cat}" class="proposal-check-grid">`;
                            grouped[cat].forEach(item => {
                                const safeTitle = escapeHtml(item.title);
                                const val = `[${CAT_NAMES[cat]}] ${safeTitle}`;
                                groupHtml += `
                                                    <label class="proposal-item">
                                                        <input type="checkbox" name="interest" value="${val}" onchange="toggleItemStyle(this)">
                                                        <span>${safeTitle}</span>
                                                    </label>`;
                            });
                            groupHtml += `</div>`;
                        }
                    });
                    if (!hasItem) groupHtml += `<p style="color:#999; padding:10px;">ë“±ë¡ëœ í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;

                    groupHtml += `</div></div>`;
                    return groupHtml;
                };

                html += createGroupHTML("ğŸ“ êµìœ¡ í”„ë¡œê·¸ë¨", EDU_CATS);
                html += createGroupHTML("ğŸ‰ í–‰ì‚¬ í”„ë¡œê·¸ë¨", EVENT_CATS);

                listArea.innerHTML = html;

            } catch (e) { console.error(e); }
        }

        // [ê¸°ëŠ¥ 1] ì²´í¬ë°•ìŠ¤ ì„ íƒ ì‹œ ì‹œê°ì  íš¨ê³¼ (ì¹´ë“œ ê°•ì¡°)
        window.toggleItemStyle = function (checkbox) {
            const label = checkbox.closest('.proposal-item');
            if (checkbox.checked) label.classList.add('checked-item');
            else label.classList.remove('checked-item');
        }

        // [ê¸°ëŠ¥ 2] ëŒ€ë¶„ë¥˜ ì•„ì½”ë””ì–¸
        window.toggleProposalCategory = function (header) {
            if (window.event) window.event.stopPropagation();
            const isAlreadyActive = header.classList.contains('active');

            document.querySelectorAll('.proposal-category-header.active').forEach(h => {
                h.classList.remove('active');
                h.nextElementSibling.classList.remove('show');
            });

            if (!isAlreadyActive) {
                header.classList.add('active');
                header.nextElementSibling.classList.add('show');
            }
        };

        // [ê¸°ëŠ¥ 3] ì¤‘ë¶„ë¥˜ ì•„ì½”ë””ì–¸ (í™”ì‚´í‘œ íšŒì „ ë¡œì§ ì¶”ê°€)
        window.toggleSubCategory = function (headerDiv) {
            if (window.event) window.event.stopPropagation();

            if (event.target.tagName === 'INPUT') {
                handleSubCategoryCheck(event.target);
                return;
            }

            const cat = headerDiv.querySelector('.parent-check').getAttribute('data-cat');
            const grid = document.getElementById(`grid-${cat}`);
            const isGridOpen = grid.classList.contains('show');

            const parentGroup = headerDiv.closest('.proposal-category-content');
            parentGroup.querySelectorAll('.proposal-check-grid.show').forEach(g => {
                if (g !== grid) g.classList.remove('show');
            });

            // ë‹¤ë¥¸ í˜•ì œ í—¤ë”ì˜ í™œì„± ìƒíƒœ(í™”ì‚´í‘œ) ì œê±°
            parentGroup.querySelectorAll('.sub-cat-header.active').forEach(h => {
                if (h !== headerDiv) h.classList.remove('active');
            });

            if (isGridOpen) {
                grid.classList.remove('show');
                headerDiv.classList.remove('active'); // í™”ì‚´í‘œ ì›ìœ„ì¹˜
            } else {
                grid.classList.add('show');
                headerDiv.classList.add('active'); // í™”ì‚´í‘œ íšŒì „
            }
        };

        function handleSubCategoryCheck(checkbox) {
            const header = checkbox.closest('.sub-cat-header');
            if (checkbox.checked) {
                header.classList.add('checked-header');
            } else {
                header.classList.remove('checked-header');
            }
        }

        // [ê¸°ëŠ¥ 4] ì†Œë¶„ë¥˜ ì„ íƒ ê°ì§€ -> ì¤‘ë¶„ë¥˜ ìë™ ì²´í¬/í•´ì œ
        document.getElementById('proposal-list-area').addEventListener('change', function (e) {
            if (e.target.name === 'interest') {
                const grid = e.target.closest('.proposal-check-grid');
                if (!grid) return;

                const checkedCount = grid.querySelectorAll('input[name="interest"]:checked').length;
                const catCode = grid.id.replace('grid-', '');
                const parentCheckbox = document.querySelector(`.parent-check[data-cat="${catCode}"]`);

                if (parentCheckbox) {
                    if (checkedCount > 0) {
                        parentCheckbox.checked = true;
                        handleSubCategoryCheck(parentCheckbox);
                    } else {
                        parentCheckbox.checked = false;
                        handleSubCategoryCheck(parentCheckbox);
                    }
                }
            }
            else if (e.target.classList.contains('parent-check')) {
                handleSubCategoryCheck(e.target);
            }
        });

        // ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        document.addEventListener('click', function (e) {
            if (e.target.closest('.proposal-category-content')) return;
            document.querySelectorAll('.proposal-category-header.active').forEach(header => {
                header.classList.remove('active');
                header.nextElementSibling.classList.remove('show');
            });
        });

        const form = document.getElementById('proposalForm');
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const btn = form.querySelector('.btn-submit');
            const originalText = btn.innerText;

            const interests = [];
            form.querySelectorAll('input[name="interest"]:checked').forEach(cb => {
                interests.push(cb.value);
            });
            document.querySelectorAll('.parent-check:checked').forEach(parent => {
                const catCode = parent.getAttribute('data-cat');
                const catName = CAT_NAMES[catCode];
                const hasChildChecked = interests.some(val => val.includes(`[${catName}]`));
                if (!hasChildChecked) {
                    interests.push(`[ê´€ì‹¬ë¶„ì•¼] ${catName} (ì„¸ë¶€í•­ëª© ë¯¸ì„ íƒ)`);
                }
            });

            if (interests.length === 0) {
                if (!confirm("ì„ íƒí•˜ì‹  í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤. ìƒë‹´ë§Œ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            }

            btn.disabled = true;
            btn.innerText = "ì „ì†¡ ì¤‘...";

            const formData = new FormData(form);
            const data = {
                type: "PROPOSAL",
                wonName: formData.get("wonName"),
                manager: formData.get("manager"),
                phone: formData.get("phone"),
                email: formData.get("email"),
                region: formData.get("region"),
                orderDetails: interests.length > 0 ? interests.join("\n") : "ë¬¸ì˜ ì‚¬í•­ ì°¸ì¡°",
                deliveryDate: formData.get("visitDate") || "ë¯¸ì§€ì •",
                remarks: formData.get("inquiry")
            };

            if (typeof CONFIG === 'undefined' || !CONFIG.PROPOSAL_SHEET_URL) {
                alert("ì„¤ì • ì˜¤ë¥˜: PROPOSAL_SHEET_URL ì—†ìŒ");
                btn.disabled = false; btn.innerText = originalText;
                return;
            }

            fetch(CONFIG.PROPOSAL_SHEET_URL, {
                method: "POST",
                body: JSON.stringify(data)
            })
                .then(res => res.json())
                .then(res => {
                    if (res.result === 'success') {
                        alert("ì„±ê³µì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        window.location.reload();
                    } else { throw new Error(res.error); }
                })
                .catch(err => {
                    console.error(err);
                    alert("ì „ì†¡ ì˜¤ë¥˜ ë°œìƒ");
                    btn.disabled = false;
                    btn.innerText = originalText;
                });
        });
    </script>
</body>
</html>