<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>뉴키즈 - 교재 발주 요청</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header></header>

    <section class="sub-hero bg-order">
        <div class="container">
            <h1>교재 발주 요청</h1>
            <p>카테고리를 선택하고 연령과 수량을 입력해 주세요.</p>
        </div>
    </section>

    <section style="background-color: #f8f9fa;">
        <div class="container">
            <form id="orderForm" class="proposal-box">
                <h3 class="form-section-title">👤 주문자 정보</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">원명 (필수)</label>
                        <input type="text" name="wonName" class="form-input" placeholder="예: 해바라기 어린이집" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">담당자 성함 (필수)</label>
                        <input type="text" name="manager" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">연락처 (필수)</label>
                        <input type="tel" name="phone" class="form-input" placeholder="010-0000-0000" maxlength="13" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">이메일</label>
                        <input type="email" name="email" class="form-input" placeholder="sample@email.com">
                    </div>
                </div>

                <div class="form-group" style="margin-top:20px;">
                    <label class="form-label">납품 희망 날짜 (선택)</label>
                    <input type="date" name="deliveryDate" class="form-input" style="max-width: 300px;">
                </div>

                <h3 class="form-section-title" style="margin-top: 40px;">📦 교재 선택 (카테고리 클릭)</h3>

                <div id="loading-msg" style="text-align:center; padding:30px; color:#666;">
                    상품 정보를 불러오는 중입니다...
                </div>

                <div id="product-list-area" class="order-list-box"></div>

                <div class="form-group full-width" style="margin-top: 20px;">
                    <label class="form-label">기타 요청사항</label>
                    <textarea name="remarks" class="form-input" style="height: 80px;" placeholder="추가 전달 사항이 있다면 적어주세요."></textarea>
                </div>

                <div class="btn-center-wrap">
                    <button type="submit" class="btn-action">발주하기</button>
                </div>
            </form>
        </div>
    </section>

    <footer></footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="manager.js"></script>

    <script>
        // 1. 카테고리 설정
        const TARGET_CATEGORIES = [
            'korean', 'reading', 'english', 'math', 'science', 'art',
            'coding', 'environment', 'nuri', 'infant', 'special'
        ];
        const CATEGORY_NAMES = {
            'korean': '🇰🇷 한글', 'reading': '📖 독서', 'english': '🔤 영어',
            'math': '🔢 수학', 'science': '🔬 과학', 'art': '🎨 미술',
            'coding': '💻 코딩', 'environment': '🌱 환경', 'nuri': '👶 누리과정',
            'infant': '🧸 영아', 'special': '⭐ 기타(특색)'
        };

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // 2. 초기화 (로딩 대기)
        document.addEventListener("DOMContentLoaded", function () {
            let attempts = 0;
            const checkSb = setInterval(() => {
                attempts++;
                if (window.sb) {
                    clearInterval(checkSb);
                    loadOrderProducts(window.sb);
                } else if (attempts > 50) {
                    clearInterval(checkSb);
                    document.getElementById('loading-msg').innerHTML = "<span style='color:red;'>서버 연결 실패. 페이지를 새로고침 해주세요.</span>";
                }
            }, 100);

            // [추가] 전화번호 자동 하이픈 (-) 기능
            const phoneInput = document.querySelector('input[name="phone"]');
            if (phoneInput) {
                phoneInput.addEventListener('input', function (e) {
                    let number = e.target.value.replace(/[^0-9]/g, ""); // 숫자만 남김
                    let tel = "";

                    // 서울(02) 지역번호 처리
                    if (number.startsWith('02')) {
                        if (number.length < 3) { tel = number; }
                        else if (number.length < 6) { tel = number.substr(0, 2) + "-" + number.substr(2); }
                        else if (number.length < 10) { tel = number.substr(0, 2) + "-" + number.substr(2, 3) + "-" + number.substr(5); }
                        else { tel = number.substr(0, 2) + "-" + number.substr(2, 4) + "-" + number.substr(6); }
                    } else {
                        // 그 외 (010, 031 등)
                        if (number.length < 4) { tel = number; }
                        else if (number.length < 7) { tel = number.substr(0, 3) + "-" + number.substr(3); }
                        else if (number.length < 11) { tel = number.substr(0, 3) + "-" + number.substr(3, 3) + "-" + number.substr(6); }
                        else { tel = number.substr(0, 3) + "-" + number.substr(3, 4) + "-" + number.substr(7); }
                    }
                    e.target.value = tel;
                });
            }
        });

        // 3. 상품 데이터 로드
        async function loadOrderProducts(sb) {
            try {
                const { data, error } = await sb.from('total_posts')
                    .select('*')
                    .in('category', TARGET_CATEGORIES)
                    .order('category', { ascending: true })
                    .order('order_num', { ascending: true });

                const listArea = document.getElementById('product-list-area');
                document.getElementById('loading-msg').style.display = 'none';

                if (error || !data || data.length === 0) {
                    listArea.innerHTML = `<div style="grid-column: 1/-1; padding:40px; text-align:center; color:#888;">주문 가능한 상품이 없습니다.</div>`;
                    return;
                }

                const groupedData = data.reduce((acc, item) => {
                    const cat = item.category || 'etc';
                    (acc[cat] = acc[cat] || []).push(item);
                    return acc;
                }, {});

                let html = "";
                TARGET_CATEGORIES.forEach(cat => {
                    if (groupedData[cat] && groupedData[cat].length > 0) {
                        html += `<div class="category-wrapper">`;
                        html += `<div class="order-category-header" onclick="toggleCategory(this)">
                                        <span>${CATEGORY_NAMES[cat] || cat}</span>
                                        <span class="toggle-icon">▼</span>
                                     </div>`;
                        html += `<div class="order-category-content">`;
                        groupedData[cat].forEach(item => {
                            const safeTitle = escapeHtml(item.title || "제목 없음");
                            html += `
                                    <div class="order-item-row" data-title="${safeTitle}" onclick="toggleProductItem(this)">
                                        <div class="order-item-info">
                                            <h4>${safeTitle}</h4>
                                            <span class="check-indicator">✔</span>
                                        </div>
                                        <div class="dynamic-qty-container" onclick="event.stopPropagation()">
                                            ${generateDynamicInputArea()}
                                        </div>
                                    </div>`;
                        });
                        html += `</div></div>`;
                    }
                });
                listArea.innerHTML = html;
            } catch (e) {
                console.error(e);
            }
        }

        // 4. [기능] 카테고리 헤더 상태 업데이트
        function updateCategoryHeaderState(element) {
            const wrapper = element.closest('.category-wrapper');
            if (!wrapper) return;
            const header = wrapper.querySelector('.order-category-header');

            const allInputs = wrapper.querySelectorAll('.dynamic-qty-input');
            let totalQty = 0;
            allInputs.forEach(input => {
                if (input.value) totalQty += parseInt(input.value);
            });

            if (totalQty > 0) header.classList.add('has-data');
            else header.classList.remove('has-data');
        }

        // 5. 토글 로직
        window.toggleCategory = function (header) {
            if (window.event) window.event.stopPropagation();
            const wrapper = header.closest('.category-wrapper');
            const isAlreadyActive = wrapper.classList.contains('active');

            document.querySelectorAll('.category-wrapper').forEach(w => {
                w.classList.remove('active');
                const content = w.querySelector('.order-category-content');
                if (content) content.classList.remove('show');
            });

            if (!isAlreadyActive) {
                wrapper.classList.add('active');
                const content = wrapper.querySelector('.order-category-content');
                if (content) content.classList.add('show');
            }
        };

        window.toggleProductItem = function (row) {
            if (window.event) window.event.stopPropagation();
            const isAlreadyActive = row.classList.contains('active');
            const parent = row.closest('.order-category-content');
            if (parent) {
                parent.querySelectorAll('.order-item-row.active').forEach(r => r.classList.remove('active'));
            }
            if (!isAlreadyActive) row.classList.add('active');
        };

        document.addEventListener('click', function (e) {
            if (!e.target.closest('.category-wrapper')) {
                document.querySelectorAll('.category-wrapper').forEach(w => {
                    w.classList.remove('active');
                    const content = w.querySelector('.order-category-content');
                    if (content) content.classList.remove('show');
                });
            }
        });

        // 6. 데이터 감지 및 상태 업데이트
        window.checkRowData = function (el) {
            const row = el.closest('.order-item-row');
            if (!row) return;

            const inputs = row.querySelectorAll('.dynamic-qty-input');
            let hasValue = false;
            inputs.forEach(input => {
                if (input.value && parseInt(input.value) > 0) hasValue = true;
            });

            if (hasValue) row.classList.add('has-data');
            else row.classList.remove('has-data');

            updateCategoryHeaderState(el);
        };

        function generateDynamicInputArea() {
            return `
                    <div class="qty-rows-wrapper">
                        <div class="qty-row">
                            <select class="age-select">
                                <option value="1">1세</option><option value="2">2세</option><option value="3">3세</option>
                                <option value="4">4세</option><option value="5">5세</option><option value="6">6세</option><option value="7">7세</option>
                            </select>
                            <input type="number" min="0" class="dynamic-qty-input" placeholder="수량" oninput="checkRowData(this)">
                        </div>
                    </div>
                    <button type="button" class="btn-add-row" onclick="addQtyRow(this)">+ 연령 추가하기</button>
                `;
        }

        window.addQtyRow = function (btn) {
            const wrapper = btn.previousElementSibling;
            const newRow = document.createElement('div');
            newRow.className = 'qty-row';
            newRow.innerHTML = `<select class="age-select"><option value="1">1세</option><option value="2">2세</option><option value="3">3세</option><option value="4">4세</option><option value="5">5세</option><option value="6">6세</option><option value="7">7세</option></select><input type="number" min="0" class="dynamic-qty-input" placeholder="수량" oninput="checkRowData(this)"><button type="button" class="btn-remove-row" onclick="removeQtyRow(this)">×</button>`;
            wrapper.appendChild(newRow);
        };

        window.removeQtyRow = function (btn) {
            const row = btn.closest('.order-item-row');
            const wrapper = btn.closest('.category-wrapper');
            btn.parentElement.remove();

            if (row) {
                const inputs = row.querySelectorAll('.dynamic-qty-input');
                if (inputs.length > 0) checkRowData(inputs[0]);
                else {
                    row.classList.remove('has-data');
                    if (wrapper) {
                        const header = wrapper.querySelector('.order-category-header');
                        const remaining = wrapper.querySelectorAll('.dynamic-qty-input');
                        let total = 0;
                        remaining.forEach(i => { if (i.value) total += parseInt(i.value); });
                        if (total > 0) header.classList.add('has-data');
                        else header.classList.remove('has-data');
                    }
                }
            }
        };

        // 7. 제출 로직
        const form = document.getElementById('orderForm');
        if (form) {
            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const btn = form.querySelector('.btn-action');
                const originalText = btn.innerText;
                const orderDetails = [];
                document.querySelectorAll('.order-item-row').forEach(row => {
                    const title = row.getAttribute('data-title');
                    const rows = row.querySelectorAll('.qty-row');
                    let hasQty = false;
                    let ageStr = [];
                    rows.forEach(qtyRow => {
                        const age = qtyRow.querySelector('.age-select').value;
                        const qty = parseInt(qtyRow.querySelector('.dynamic-qty-input').value);
                        if (qty > 0) { hasQty = true; ageStr.push(`${age}세(${qty}권)`); }
                    });
                    if (hasQty) orderDetails.push(`[${title}] : ${ageStr.join(', ')}`);
                });

                if (orderDetails.length === 0) {
                    alert("수량을 입력한 교재가 없습니다.");
                    return;
                }

                btn.disabled = true; btn.innerText = "전송 중...";
                const formData = new FormData(form);
                const data = {
                    type: "ORDER",
                    wonName: formData.get("wonName"),
                    manager: formData.get("manager"),
                    phone: formData.get("phone"),
                    email: formData.get("email"),
                    deliveryDate: formData.get("deliveryDate") || "미지정",
                    orderDetails: orderDetails.join("\n"),
                    remarks: formData.get("remarks"),
                    timestamp: new Date().toLocaleString()
                };

                fetch(CONFIG.ORDER_SHEET_URL, { method: "POST", body: JSON.stringify(data) })
                    .then(res => res.json())
                    .then(res => {
                        if (res.result === 'success') { alert("발주 요청 성공!"); window.location.reload(); }
                        else { throw new Error(res.error); }
                    })
                    .catch(err => {
                        console.error(err); alert("전송 실패"); btn.disabled = false; btn.innerText = originalText;
                    });
            });
        }
    </script>
</body>
</html>