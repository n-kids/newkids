<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>뉴키즈 - 상세 내용</title>
    <link rel="stylesheet" href="style.css">

    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <style>
        /* 1. 텍스트 정렬 강제 적용 */
        .view-content .ql-align-center {
            text-align: center !important;
        }

        .view-content .ql-align-right {
            text-align: right !important;
        }

        .view-content .ql-align-justify {
            text-align: justify !important;
        }

        /* 2. 이미지 정렬 강제 적용 */
        .view-content .ql-align-center img {
            display: block;
            margin: 0 auto !important;
        }

        .view-content .ql-align-right img {
            display: block;
            margin-left: auto !important;
            margin-right: 0 !important;
        }

        .view-content .ql-align-left img {
            display: block;
            margin-left: 0 !important;
            margin-right: auto !important;
        }
    </style>
</head>
<body>
    <header></header>
    <div id="loading" class="loading-overlay">내용을 불러오는 중입니다...</div>

    <section class="sub-hero bg-season" id="view-hero">
        <div class="container">
            <h1 id="page-title">상세 보기</h1>
            <p>뉴키즈의 다양한 활동을 확인해 보세요.</p>
        </div>
    </section>

    <section>
        <div class="container-wide">
            <div class="view-box">
                <div class="view-header">
                    <h2 class="view-title" id="post-title">로딩 중...</h2>
                    <p class="view-date" id="post-date">0000-00-00</p>
                </div>

                <div class="view-media" id="view-media" style="display:none;"></div>

                <div class="view-content ql-editor" id="post-content"></div>

                <div id="link-container" style="text-align: center; margin: 40px 0 20px;"></div>

                <a href="javascript:history.back()" class="btn-list">목록으로 돌아가기</a>
            </div>
        </div>
    </section>

    <footer></footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="manager.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const params = new URLSearchParams(window.location.search);
            const postId = params.get('id');

            if (postId) {
                // Supabase 연결 대기 (안전장치)
                const checkSb = setInterval(() => {
                    if (window.sb) {
                        clearInterval(checkSb);
                        loadPostDetail(postId);
                    }
                }, 100);
            }
        });

        // 확장자로 비디오 파일인지 확인하는 함수
        function isVideo(url) {
            if (!url) return false;
            return /\.(mp4|webm|ogg|mov|avi|mkv)(\?|$)/i.test(url);
        }

        async function loadPostDetail(id) {
            document.getElementById('loading').style.display = 'flex';
            try {
                const { data, error } = await window.sb.from('total_posts').select('*').eq('id', id).single();
                if (error || !data) throw new Error("데이터 없음");

                document.getElementById('post-title').innerText = data.title;
                document.getElementById('post-date').innerText = window.formatDate(data.created_at);
                document.getElementById('post-content').innerHTML = data.content;

                // [미디어 처리 핵심 로직 수정]
                const mediaBox = document.getElementById('view-media');
                mediaBox.innerHTML = '';

                // 1. DB에서 값 가져오기 (없으면 빈 문자열)
                let rawVideo = data.video_url || "";

                // 2. 값 정제 (공백 제거)
                let videoVal = rawVideo.trim();

                // 3. 예외 조건 필터링 (발주 전용, null 문자열 등)
                if (videoVal === 'ORDER_ITEM' || videoVal === 'null' || videoVal === '') {
                    videoVal = null;
                }
                else if (videoVal.startsWith('ORDER_ALL|')) {
                    // 'ORDER_ALL|주소' 형식일 경우 주소 부분만 추출
                    const parts = videoVal.split('|');
                    if (parts.length > 1 && parts[1].trim() !== '') {
                        videoVal = parts[1].trim();
                    } else {
                        videoVal = null;
                    }
                }

                // 4. [중요] 실제 주소인지 최종 확인 (http로 시작하지 않으면 무효 처리)
                if (videoVal && !videoVal.startsWith('http')) {
                    videoVal = null;
                }

                // 5. 화면 표시 로직
                // (1) 유효한 비디오 URL이 있는 경우
                if (videoVal) {
                    const yid = window.getYoutubeId(videoVal);
                    // 유튜브 ID가 있으면 iframe, 없으면 일반 video 태그
                    mediaBox.innerHTML = yid
                        ? `<iframe src="https://www.youtube.com/embed/${yid}" frameborder="0" allowfullscreen></iframe>`
                        : `<video controls style="width:100%; border-radius:10px;"><source src="${videoVal}"></video>`;
                    mediaBox.style.display = 'block';
                }
                // (2) 비디오는 없는데 상단 이미지(image_url)가 있는 경우
                else if (data.image_url && data.image_url !== 'null' && data.image_url.trim() !== '') {
                    // 혹시 이미지 URL 칸에 비디오 파일을 넣었을 경우 대비
                    if (isVideo(data.image_url)) {
                        mediaBox.innerHTML = `<video controls style="width:100%; border-radius:10px;"><source src="${data.image_url}"></video>`;
                    } else {
                        mediaBox.innerHTML = `<img src="${data.image_url}" onerror="this.parentElement.style.display='none'">`;
                    }
                    mediaBox.style.display = 'block';
                }
                // (3) 둘 다 없으면 숨김
                else {
                    mediaBox.style.display = 'none';
                }

                // [관련 링크 버튼]
                const linkBox = document.getElementById('link-container');
                linkBox.innerHTML = "";

                if (data.link_url && data.link_url.trim() !== "" && data.link_url !== "null") {
                    let finalLink = data.link_url.trim();
                    if (!finalLink.startsWith('http')) finalLink = 'https://' + finalLink;

                    linkBox.innerHTML = `
                            <a href="${finalLink}" target="_blank" class="link-btn-style">
                                🔗 관련 사이트 바로가기
                            </a>`;
                }

                // [배경 이미지 업데이트] - 재귀 호출 방지 적용
                if (typeof window.updateHeroBackground === 'function') {
                    window.updateHeroBackground(data.category);
                } else {
                    applyLocalHero(data.category);
                }

            } catch (err) {
                console.error(err);
                alert("불러오기 실패: " + err.message);
                history.back();
            }
            finally { document.getElementById('loading').style.display = 'none'; }
        }

        // 로컬 배경 적용 함수 (manager.js 로드 실패 시 백업용)
        function applyLocalHero(category) {
            const hero = document.getElementById('view-hero');
            const catMap = {
                'season': 'bg-season', 'culture': 'bg-culture', 'performance': 'bg-performance',
                'korean': 'bg-child', 'reading': 'bg-child', 'english': 'bg-child',
                'math': 'bg-child', 'science': 'bg-child', 'art': 'bg-child',
                'coding': 'bg-child', 'environment': 'bg-child', 'nuri': 'bg-child',
                'infant': 'bg-child', 'special': 'bg-child'
            };
            if (hero) {
                hero.className = 'sub-hero ' + (catMap[category] || 'bg-gray');
            }
        }
    </script>
</body>
</html>